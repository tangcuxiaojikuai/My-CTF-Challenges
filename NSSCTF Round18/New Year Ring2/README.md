## New Year Ring2

+ Difficulty：Middle
+ Solved：3

<br/>

## Description

新年用个新新环！

<br/>

## Solution

这一题是上一题的加强，相对于上一题来说，本题又把商环更换为了：
$$
\frac{Z_p[x]}{x^{64}+2x^3+2x+4}
$$
但是目标是不变的，仍然是要利用s和e系数较小这一点，去设法构造格进行规约。

要构造出格就要先构造出商环中多项式乘积的矩阵表示。本题的难点也就在于，商环中现在不仅存在64次项和常数项，还存在一次项和三次项，那么该怎么去构造这个矩阵呢？

我们仍然是利用如下一点：
$$
x^{64} = -(2x^3+2x+4) \quad(mod\;x^{64}+2x^3+2x+4)
$$
所以有：
$$
x^{64+i} = -(2x^{3+i}+2x^{1+i}+4x^{i}) \quad(mod\;x^{64}+2x^3+2x+4)
$$
那么对于之前举的多项式a乘b得到c的例子，我们假设ab乘完后先不模x^64+2x^3+2x+4，记这个乘积为d，那么d就有0到2x63次项。而由于上面推得的这个商环下多项式的同余关系，对于c中的各项系数来说，其0次项的系数应该有d中的0次项以及64次项的参与，其1次项应该有d中的1次项、64次项以及65次项参与，其2次项应该有d中的2次项、65次项以及66次项参与，其3次项应该有d中的3次项、64次项、66次项、67次项参与，......以此类推。

但是有一个需要注意的问题是，右边由于存在3+i和1+i项，所以有些项可能需要多次模，比如对于i=61就有：
$$
x^{64+61} = -(2x^{64}+2x^{62}+4x^{61}) \quad(mod\;x^{64}+2x^3+2x+4)
$$
右边的x^64就又需要展开，得到的最终式子是：
$$
x^{64+61} = -(2(-(2x^3+2x+4))+2x^{62}+4x^{61}) = -2x^{62}-4x^{61}+4x^3+4x+8
$$
可以注意到，因为最高次项也只会有126次，所以只有i=61、62的时候需要进行二次模运算，不妨把i=61、62的情况一并列出：
$$
x^{64+61} = -2x^{62}-4x^{61}+4x^3+4x+8
$$

$$
x^{64+62} = -2x^{63}-4x^{62}+4x^4+4x^2+8x
$$

所以次数为0到4的项的系数还需要额外调整一下。那么对于这道题中的S乘A的过程，就可以构造出这一次的多项式乘积矩阵如下：
$$
(s_0,s_1,s_2,s_3,...s_{63})
\left(
 \begin{matrix}
   a_0     &a_1              &a_2                &a_3&\cdots &a_{63}\\
   -4a_{63}&a_0-2a_{63}      &a_1                &a_2-2a_{63}&\cdots &a_{62}\\
   -4a_{62}&-4a_{63}-2a_{62} &a_0-2a_{63}        &a_1-2a_{62}&\cdots &a_{61}\\
   -4a_{61}&-4a_{62}-2a_{61} &-4a_{63}-2a_{62}   &a_0-2a_{63}-2a_{61}&\cdots &a_{60}\\
   \vdots &\vdots &\vdots&\vdots&\ddots &\vdots\\
   -4a_1+8a_{62}    &-4a_2-2a_1+4a_{62} +8a_{63}      &-4a_3-2a_2+4a_{63}          &-4a_4-2a_3-2a_1+4a_{62}&\cdots &a_0-2a_{63}-2a_{61}\\
  \end{matrix}
  \right)
$$
造的格子就和上一道题目是一样的了，把矩阵换成上面这个就行。

exp：

```python
from Crypto.Util.number import *
from random import *

n = 64
A = [25628433222756085994492259068849402115, 108192689210265022288173745176216677895, 85974352459523213168503152436203993854, 41828313114844948099739205193013146660, 15961445864161535368425735570577871568, 59860624089211511801244965491114405123, 72238114736535717286419734164194491146, 1731419769773538054984020741260144321, 110926179088722293171658261432626666958, 4729059639835826882559436203284470206, 168495809056757598731123948067040373565, 3338360642630078653320363127167526308, 19389936220034072874232261675901806153, 10438117635879553768611012406691341169, 153667038046207304584441437937384897775, 72166665774655568880543097047667804863, 95319528381704092095798376951073542165, 62898039808274250589921375492358418705, 38256076367009076141369526506747299307, 116682168147974451260364221046574659055, 26917522774848180141649752130328445540, 155767907175579627310170473659502971153, 77475859845928815191730640478115081925, 70014064310214050035280946814599808820, 85993451838284022745989979544017241858, 1559588202521630621698182776746048258, 52424771201426327411234245307354332594, 92380990205273211168316314938871853614, 55868954214861940284812204603983552046, 86766496415006406161245997036503548760, 65631024912623216715877274133399692328, 165552413066518454864366169079315182837, 27090806019996818214310558040178209015, 24884235560487406082425405304334927881, 167131388381252997695719535111304864318, 84309157064049564271714180786273613498, 53226032826639984552629376026393806036, 10043888404273006035387494091731007691, 12579929759225042382751229048796566699, 166363316914893642035801926729741157934, 37839073681950914796852925854557791313, 59823734019834883911363191453005985507, 72713054697995652053446065501322532087, 7355549923971285393506940087861413681, 21734747677920938504945342916533076569, 93933129166049277428941778125233010374, 58955842096425290408052247755008181893, 35959399375270454336325579486716264076, 134512300913738209016228764504703580317, 156877088942396466398635185398252103142, 104513294126348280186621088034948750337, 58139022317938952038809444482141783106, 98565612260156356115401166878515345986, 114416081175175578305854221578018095237, 22901750234260702478992290068664968479, 156611313609023033314989985233189973832, 125083132555321363078288077242345281728, 41404163164349704408020008746598776378, 148785934103979787297708145558354509586, 60576000474984112015781658795707443603, 157378782433123699827402744836263199181, 115808625117495689666174307128964343007, 55532885470248050887252206269085843644, 167226824329071601899518640284153209079]
B = [125436276837023032466255967451858640606, 144448119937248956307846718982491347769, 162306129951573761575068204811168998078, 83181011846487027653033036479190112408, 40957533970438134530667298492545012058, 39781894692503876914564462045404705807, 164051006333092368306831348749408921012, 111012742481005666423330275146981180733, 7715720858029882578293974044643808669, 157677217515339873901600902409190036650, 47743593975916243882559558507891093023, 157986164305142738632123943371346719550, 127635891927296917312348404019956617317, 29559276398124624593609203169860820474, 65960871111768788316941346555260753893, 168042316135611110131429808009369471733, 1212659292467585393525194729053590464, 131142075720852427381782478157244639696, 102842995705164719704337121568124710266, 34358829636338044181518280022135929086, 46061675284276849395800943167734760351, 135977825342856793359560567810384022667, 79194609568617048147045548433187673199, 3676419995870098657902754244090307337, 129102404404523795672123957629514020212, 132931883751740337774987369503377603250, 157631873978881249131112881234813720862, 25064634967243118171242164160769943822, 90201135758213533081777343764941590513, 28708219563163506588485189820706388938, 56568253458138625936076514562071708932, 6347413009696777418004642228340087455, 142708918733729617152197380466325161544, 90675635242552386205397936839615479057, 92501808867676816791538575898905495372, 119574898086174634261072854178847743198, 109965735435324316785759245560872940757, 88027969746581556885954470651939385855, 134321591115155640446804238393795645472, 138737181251155600814378949277591209336, 99644145229459444132485749993357552167, 72102411291892187794699247448258325603, 83762370748394317206974170435605895442, 50088402451174667055894866569295371337, 151985189458457003469569692195947019009, 94074842589490698882361618773816024181, 73064286019059695311967281427732071049, 15926695040044471692620032927734856548, 92040182094543438421700664648795356800, 72067816134410856572981520568082148623, 51543145349488111975169803932104264498, 133476358234399233123899184886685568681, 138871089323661273034769987507240180967, 135182088478518211398715618356312799892, 142132493504501637417871042380487888261, 152821195684002682180600788766787854997, 108605984719600234041614912160255546443, 107009285527858918462712915168386920973, 142315287684855833566016316758770217595, 120564701831156855156008640956601967150, 76342952544707200039421682949094541165, 1616883292120605398623492917180224681, 114803483209077151333130433872010751344, 59602734024539592667147877839382863851]
p = 171384865635734387982308861436753436427


#part1 construct matrix of poly_mul
poly_mul_mat = Matrix(ZZ,n,n)

#first column
poly_mul_mat[0,0] = A[0]
for i in range(1,n):
    poly_mul_mat[i,0] = -4*A[n-i]
#handle special twice mod 
poly_mul_mat[-1,0] += 8*A[-2]
poly_mul_mat[-2,0] += 8*A[-1]

#2-3 column
for col in [1,2]:
    poly_mul_mat[col,col] = A[0] - 2*A[n-1]
    for i in range(col):
        poly_mul_mat[i,col] = A[col-i]
    for i in range(n-1-col):
        poly_mul_mat[col+i+1,col] = -4*A[n-1-i]-2*A[n-1-i-1]
#handle special twice mod 
poly_mul_mat[-1,1] += 4*A[-2] + 8*A[-1]
poly_mul_mat[-2,1] += 4*A[-1]
poly_mul_mat[-1,2] += 4*A[-1]

#rest column
for col in range(3,n):
    poly_mul_mat[col-2,col] = A[2] - 2*A[n-1]
    poly_mul_mat[col-1,col] = A[1] - 2*A[n-2]
    poly_mul_mat[col,col] = A[0] - 2*A[n-1] - 2*A[n-3]
    for i in range(col-2):
        poly_mul_mat[i,col] = A[col-i]
    for i in range(n-1-col):
        poly_mul_mat[col+i+1,col] = -4*A[n-1-i]-2*A[n-1-i-1]-2*A[n-1-i-3]
#handle special twice mod 
poly_mul_mat[-1,3] += 4*A[-2]
poly_mul_mat[-2,3] += 4*A[-1]
poly_mul_mat[-1,4] += 4*A[-1]


#part2 construct Lattice of RLWE
I = identity_matrix(n)
B_mat = Matrix(ZZ,B)
O = diagonal_matrix([0]*n)
O_vec = Matrix(ZZ,1,n)
O_vec_T = Matrix(ZZ,n,1)
L = block_matrix(ZZ,[[p*I,O,0],[poly_mul_mat,I,O_vec_T],[B_mat,O_vec,1]])


#part3 LLL to get s and get flag
res = L.LLL()[0]
s = res[n:2*n]
for i in s:
    print(chr(abs(i)),end = "")


#NSSCTF{M4st3r_0F_RLWE_h3r3_15_ur_flag_4nD_HHHHappy_niu_Ye4r!!}
```

