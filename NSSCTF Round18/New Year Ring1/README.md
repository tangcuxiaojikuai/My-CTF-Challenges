## New Year Ring1

+ Difficulty：Easy
+ Solved：4

<br/>

## Description

新年用个新环！

<br/>

## Solution

题目就是一个RLWE，只是改变了其环R为：
$$
\frac{Z_p[x]}{x^{64}+2024}
$$
具体来说，题目将长度不到64的flag串编码成R上的多项式S，然后生成随机多项式A，并且随机生成一个小噪声多项式E，计算出：
$$
B = AS + E 
$$
给出A、B，要求还原S。

实际上攻击的点就在于多项式S的系数都是ASCII码值，所以在模p下显得很小，从而可以用格攻击。

如果本身就了解RLWE造格的具体原理的话这题目就很简单，只需要略微改一改格就很快能做出。但如果一直以来造RLWE的格都是直接找别人的脚本跑、而不知道具体原理的话，可能就不太清楚如何改起。这里简单阐述一下其造格的思路，先从多项式乘法的矩阵表示讲起。

#### 多项式乘法的矩阵表示

首先，对于一个多项式，我们可以用一个由其系数组成的向量来表示这个多项式，而不同幂次就仅仅代表着系数在多项式中的位置。那么现在把眼光放回这个题目里，由于环R的模多项式度是64，所以其中的多项式次数最高为63，因此对于这题目中的多项式S，我们可以把它写作如下向量：
$$
(s_0,s_1,s_2,...s_{63})
$$
它对应的多项式就是：
$$
S = s_0 + s_1x + s_2x^2 + ... + s_{63}x^{63} 
$$
同理多项式B、E也就可以写成是：
$$
(b_0,b_1,b_2,...b_{63})
$$

$$
(e_0,e_1,e_2,...e_{63})
$$

接下来的问题是，我们如何把多项式的乘法，也就是AS这个计算过程写成矩阵表示。这一部分详细一点可以参考：

[NTRU学习笔记 | Tover' Blog](https://tover.xyz/p/NTRU/#多项式卷积乘法)

其实核心思路并不复杂，比如对于上文中的环R，其模多项式是：
$$
x^n - 1
$$
这其实也就说明一个事情，在环R中总有：
$$
x^n = 1 \quad(mod \; x^n-1)
$$
这也就是说：
$$
x^{n+i} = x^i \quad(mod \; x^n-1)
$$
那么我们假设对于两个环R中的多项式a、b相乘，其得到的结果是c。我们知道a、b、c的最高次项的次数都小于n。所以如果我们仅仅计算ab乘积而不模x^n-1的话，他最多就有0到2n-2次项。又由上面的x^(n+i)=x^i，我们就可以推得下面这个重要性质：

+ 乘积c中的i次项系数，其实就是ab乘积中的i次项系数与n+i次项系数之和

那么我们就可以根据这个性质写出多项式乘法的矩阵表示了。我们设a、b、c分别为：
$$
(a_0,a_1,a_2,...a_{n-1})
$$

$$
(b_0,b_1,b_2,...b_{n-1})
$$

$$
(c_0,c_1,c_2,...c_{n-1})
$$

比如对于c0，其代表的含义是ab乘积的0次项的系数，对应的我们就需要找ab乘积中的所有**0次项以及n次项**的系数并求和就得到c0；同理c1就找ab中的1次项以及n+1次项系数求和，以此类推。

这就得到了多项式乘法的矩阵表示形式：
$$
(a_0,a_1,a_2,...a_{n-1})
\left(
 \begin{matrix}
   b_0    &b_1    &b_2   &\cdots &b_{n-1}\\
   b_{n-1}&b_0    &b_1   &\cdots &b_{n-2}\\
   b_{n-2}&b_{n-1}&b_0   &\cdots &b_{n-3}\\
   \vdots &\vdots &\vdots&\ddots &\vdots\\
   b_1    &b_2    &b_3   &\cdots &b_0\\
  \end{matrix}
  \right)
  =
  (c_0,c_1,c_2,...c_{n-1})
$$
需要注意的是，刚才我们讨论的环是模x^n-1下的，所以才会有x^(n+i)=x^i这一事实。而在本题目中环R是在模x^64+2024下的，上面的式子不成立，那么又该怎么办？

做法也很简单，相似的道理有：
$$
x^{64} = -2024 \quad(mod \; x^{64}+2024)
$$
所以其实也就略微变了点样子，这个环中具有的性质是：
$$
x^{64+i} = -2024x^{i} \quad(mod \; x^{64}+2024)
$$
所以对于该环中的多项式ab相乘得到c的过程，可以写作如下矩阵：
$$
(a_0,a_1,a_2,...a_{n-1})
\left(
 \begin{matrix}
   b_0    &b_1    &b_2   &\cdots &b_{n-1}\\
   -2024b_{n-1}&b_0    &b_1   &\cdots &b_{n-2}\\
   -2024b_{n-2}&-2024b_{n-1}&b_0   &\cdots &b_{n-3}\\
   \vdots &\vdots &\vdots&\ddots &\vdots\\
   -2024b_1    &-2024b_2    &-2024b_3   &\cdots &b_0\\
  \end{matrix}
  \right)
  =
  (c_0,c_1,c_2,...c_{n-1})
$$
到这里我们就完成了该环下多项式的矩阵构建。

#### 格攻击

其实只要能把矩阵造出来，那么在网上找一个RLWE的脚本并把矩阵换成上面这个，那么已经可以做出题目了。不过为了wp完整性还是简单说一下构造格的思路。我们知道对于题目中128bit的模素数p而言，E和S都是系数相当小的多项式，因此我们构造格的目的是在目标向量中找到他们。

为此我们可以把多项式乘法写成下面这样：
$$
E = AS - B
$$
然后就是用刚才的矩阵来造格：
$$
\left(
\begin{matrix}
   p\\
   &p\\
   &&p\\
   &&&\cdots\\
   &&&&p\\

   a_0    &a_1    &a_2   &\cdots &a_{n-1}            &1\\
   -2024a_{n-1}&a_0    &a_1   &\cdots &a_{n-2}       &&1\\
   -2024a_{n-2}&-2024a_{n-1}&a_0   &\cdots &a_{n-3}  &&&1\\
   \vdots &\vdots &\vdots&\ddots &\vdots             &&&&\cdots\\
   -2024a_1    &-2024a_2    &-2024a_3   &\cdots &a_0 &&&&&1\\
   
   b_0    &b_1    &b_2   &\cdots &b_{n-1}&&&&&&1\\
  \end{matrix}
  \right)
$$
这个格具有的线性关系是：
$$
(k_0,k_1,k_2,...k_{63},s_0,s_1,s_2,...s_{63},1)
\left(
\begin{matrix}
   p\\
   &p\\
   &&p\\
   &&&\cdots\\
   &&&&p\\

   a_0    &a_1    &a_2   &\cdots &a_{n-1}            &1\\
   -2024a_{n-1}&a_0    &a_1   &\cdots &a_{n-2}       &&1\\
   -2024a_{n-2}&-2024a_{n-1}&a_0   &\cdots &a_{n-3}  &&&1\\
   \vdots &\vdots &\vdots&\ddots &\vdots             &&&&\cdots\\
   -2024a_1    &-2024a_2    &-2024a_3   &\cdots &a_0 &&&&&1\\
   
   b_0    &b_1    &b_2   &\cdots &b_{n-1}&&&&&&1\\
  \end{matrix}
  \right)
  =
  (e_0,e_1,e_2,...e_{63},s_0,s_1,s_2,...s_{63},1)
$$
前面的ki是因为我们的环还需要对多项式的所有系数模p，所以所有系数求和模p后展开的等式中都含有一个kip。

然后对这个格做LLL就能在第一行找到我们的目标向量了，取中间的64个数字，也就得到flag的全部字符。

exp：

```python
from Crypto.Util.number import *

n = 64
A = [203211966212120647994404162543901058385, 113998159211311856163959557092243561040, 300945935078651395200612763362025786190, 289539358962072307485802285781112184506, 266860644401078099268835882620812059236, 109469988130078797414202659254940150397, 142193430695353860553837582452159920561, 163603443131512016589524436620766900399, 125570052004030843134707673404921516235, 289517595415670285587801685152176297797, 260336477592153246815046507549532230446, 89128330175853905837766718032373473126, 187717315035064338496744033397006646838, 47398231438108384695170959715078016751, 320133498675264306580441374518511607677, 289224545427213583554005441616103706530, 48124450498844786580485017131751952117, 139700877104641187048620578708689412417, 71574579434689200165233820726593943746, 138252394765364749010226318178055019086, 261521192680609185598298661488532314373, 226827408720691280529315243806063440819, 312302166514031202715929873278517388968, 41543713499646037109947736777306720313, 265649922622063773566846630839697709881, 243184423040946982395304999253912592156, 206198258022435934039803402480943364253, 26031203447491686152181680360833340987, 267200487804167757054737887061948559784, 301825292179107181769802726785989059100, 245678367957552191949253880949910260990, 171086126608355874606827637031412493750, 238890683861901290139689496391030872360, 22845910272546674819720769022817968767, 28421978727921425902205492605476665131, 171865962533483544755013698922220144571, 133361830829435140268114465077140337526, 86265129464226210912927536339928098681, 68669331909862762270788724935161403154, 201866646039120111937128925580825280486, 13363589230429215865126757180274178298, 17909430443917365585897023486940736171, 91757667623716596753047172893731203404, 46825614193892927425213536328954419018, 131552079476235333764480742173849445520, 235812708672214623030453261917981487844, 128419026868422646823814506658958018620, 165071194644940049087362229894395125949, 119007848732714973887391773573107966930, 142175857554093924103634649494868118501, 324116975329566500720942384202511507819, 145202961579339260969095793970625895397, 302068925092915352636494174062039213344, 204865812301701145536309778960425467197, 73204183646529021271666811846606597696, 305266620775559116657495389805588046145, 38573243820497560644612322159835262762, 204132117511623685134894865125985283485, 152661573492853637425833316355962196973, 234147606390346795925961511757446390699, 101214795511329059676976012743816028858, 45259554101612024332508390665659000501, 69808091348685800959727855379331581323, 96236770545429224235813571394198156104]
B = [122276244512812151700561410687880152355, 288902265068638112029210922418017307765, 227157280930411828282688954386270375417, 51392889392439935890454046852827718770, 107818090106926819686128970258855341987, 39797693303511873260100821082668360148, 165165311283389310714977999739406590465, 145742713856100761940986808065029032102, 85681122792038178595571398323505588215, 161750232371529874705027252096297284499, 65492947650590100527727115268504178500, 158980937836523416847183159463389719119, 217622237154991741032187619647917235486, 214403448117831129512734472087177528755, 7203970244866082501778704003244517036, 209327947737263058848347484690330837593, 261471938052725575109694161428073566879, 290548445194039386389333379248698464710, 786777047021934678707520080022646500, 181116047323074255804762916647191259040, 321394759425138484862188864303222149962, 172828377940330639355360387538637264455, 66514389687485973164456706712404934406, 123351805496712587796702291879739918777, 52527849016391552904401277415521541344, 269082045250550515743652451127140175208, 46611178931314336386280465499464556662, 306738233577541073584072095728624359658, 27700046031756446145225137030746217892, 90225963569273234686624144350335934112, 67692467833088163585206113599832005433, 323500338166210082579512376483956531150, 268393735497552347113220159171930201434, 303137349721700995847836323480358301717, 37409490969034515063902941681541879806, 89987553043378360059649171549894177100, 177195833588614025644477178454034861283, 186453862621405866128018280976135392700, 134539827243365382868881776050914249090, 174423939567752183215031097600196039560, 141295420547653230540490506885038874517, 71077155156144579112947495766255667953, 219294250229364145810766028169964010349, 32511078113518753980651829431342417337, 303329577727497287329206502612155346064, 90557253357868638265309134765551619996, 274174517174776162629592599514881337711, 49932861529770838835799830915660452043, 12677314962488846037929508134986771433, 234965385179859810854399287906068885976, 11962701379314564572722140202812617562, 315105728460289255044517314167781474357, 92397698128764550243762952707724608359, 79161472796010129344236399474925315198, 8230717415162461432383488082982662910, 187550346095617606538292501947907284159, 111838535125019998906719357578490542024, 127632981408215865540832181515313916183, 77787230784265032836219137545199240126, 209675082880646980235572000733260128373, 318088800052782828672155510824979199450, 197936332876846440605381880211398578620, 163607618093826671398256369217224613243, 325974106851521509536970685901401508674]
p = 330464659390823375471800230370495966901

#part1 construct matrix of poly_mul
poly_mul_mat = Matrix(ZZ,n,n)
for i in range(n):
    for j in range(i+1):
        poly_mul_mat[j,i] = A[i-j]
    for j in range(n-i-1):
        poly_mul_mat[j+i+1,i] = A[-(j+1)]*(-2024)


#part2 construct Lattice of RLWE
I = identity_matrix(n)
B_mat = Matrix(ZZ,B)
O = diagonal_matrix([0]*n)
O_vec = Matrix(ZZ,1,n)
O_vec_T = Matrix(ZZ,n,1)
L = block_matrix(ZZ,[[p*I,O,0],[poly_mul_mat,I,O_vec_T],[B_mat,O_vec,1]])


#part3 LLL to get s and get flag
res = L.LLL()[0]
s = res[n:2*n]
for i in s:
    print(chr(abs(i)),end = "")

#NSSCTF{U_c4n_5olv3_th1s_pr0b!em_0nce_u_kn0W_M4trix_0f_Polymu1}
```

题目本身如果了解RLWE的话就很基础，主要是想通过wp帮助一些不太了解多项式乘法的cryptoer找找构建成矩阵的思路，从而不再只是调脚本跑。

