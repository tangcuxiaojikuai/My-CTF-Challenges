from Crypto.Util.number import *
from flag import flag

def iscube(n, p): 
	return pow(n, (p-1) // gcd(3, p-1), p) == 1

def issquare(n, p): 
	return Mod(n, p).is_square()

def gen_prime(nbit, t):
	P = []
	for _ in range(t):
		while True:
			p = getPrime(nbit)
			if p % 3 * p % 4 == 3:
				P.append(p)
				break
	return P

def add(P, Q, c, n):
	# Add two points P and Q on curve x^3 + c*y^3 + c^2*z^3 - 3*c*x*y*z = 1 in Zmod(n) 
	(x1, y1, z1) = P
	(x2, y2, z2) = Q
	x3 = (x1*x2 + c*(y2*z1	+ y1*z2))	% n
	y3 = (x2*y1 + x1*y2		+ c*z1*z2)	% n
	z3 = (y1*y2 + x2*z1		+ x1*z2)	% n
	return (x3, y3, z3)


def mul(P, g, c, n):
	# Scalar multiplication on curve
	(x1, y1, z1) = P
	(x2, y2, z2) = (1, 0, 0)
	for b in bin(g)[2:]:
		(x2, y2, z2) = add((x2, y2, z2), (x2, y2, z2), c, n)
		if b == '1': 
			(x2, y2, z2) = add((x2, y2, z2), (x1, y1, z1), c, n)
	return (x2, y2, z2)

def keygen(nbit, r, s):
	p, q = gen_prime(nbit, 2)
	n, o = p^r * q^s, p*q*(p^2+p+1)*(q^2+q+1)*(p - 1)^2*(q - 1)^2
	e = randint(1, n)
	while gcd(e, o) != 1: e = randint(1, n)
	E = [
		p^(2*(r-1))*q^(2*(s-1))*(p^2+p+1)*(q^2+q+1),
		p^(2*(r-1))*q^(2*(s-1))*(p - 1)^2*(q - 1)^2,
		p^(2*(r-1))*q^(2*(s-1))*(p^2+p+1)*(q - 1)^2,
		p^(2*(r-1))*q^(2*(s-1))*(p - 1)^2*(q^2+q+1)
		]
	D = [inverse(e, _) for _ in E]
	return (n, e), (p, q, D)
	
def encrypt(m, pubkey):
	(n, e) = pubkey
	(x, y) = m
	c = ((1 - x^3) * inverse(y^3, n)) % n
	enc = mul((x, y, 0), e, c, n)
	return enc
	
nbit, r, s = 512, 4, 6
pubkey, _ = keygen(nbit, r, s)

l = len(flag)
m = (bytes_to_long(flag[:l//2]), bytes_to_long(flag[l//2:]))
assert m[0] < pubkey[0] and m[1] < pubkey[0]
enc = encrypt(m, pubkey)

print(f'pubkey = {pubkey}')
print(f'enc = {enc}')


'''
pubkey = (59009206274539135485399426170858617720053822613205956983069857819153712388816034644925883251386717179627798510771274600705820923632361234522708076353791953230270026846293307342935195085543469228028672763588068302392837223920600453493181308635217223586112248338309884937345480253124158287236515270110920405572835015111708607761142629297875047561867588513565934243705710533798200182572881497512161912506020737063343365511687472606499308570696674800426533015821185894567403069609219585041694899260226250461874133592018973844464705811292051875502496835884114863267168239487996196607108111266738222070034133981876309909660042558150642098690340099649823002605920308041591545256969668007718351788856607056437018969507543646292927368849222570290491524426370936020101628511321424744143419243549113588446595988607943538854525966419823368079606413246875403728958041103380007307555107608487966387638964121838270678801562976364217978160971155363150872512497370340939038182526258288059322418970746205937229307260112511454523040560625353064028927096356036915279955499071001073659273374197462346048943081236849998628335367626361519719617975622303844984900007677624607580460437124779090121003283091156514977294631582240206049668304214536396127043688810616911091101556761772672553245620236316852831604279370775693583150541452021515065249303744283744721946908000165431656877977599279495226280564961085979248977066340771432652848023795332644641427979840363221785652052147547890923618408538674203420834161647213837433057655120057989389702880928607233586991768521, 44693688243625077245198440522609401613164364072621778717150056254264114410537295425845542364792604935473071785183580567241938925343061350868026309856963273947025048788572459951352490828549566141815357209080952176949413734734705837756952882216315096393703414615224555071255287107200059760528894746001566339345255335337716394099620398425945462116387688796421552227796063404151817014311692122682544605396362136780452517258657888451930815495747424947130188970695509602127068508467906172483608842939993935904590920301398185184592659919519223673845296202942521984626605078972361594865699980526456381111842694331683112430576215380234856106648444176080622905362366461589650295926704225501191752353370765337997102762039090357388155132455804118801346299596514978523237199519566337196479094181639054878762049979006461735088513585815180562227894901686198554424129724764101703204143242787758007714782227107639182041749946077707301465060425375109651630218809484340891796176045884023845690616805410895283407824317549130114804257371412928713551262700791320450876730051273289127700571703845839735335885962143624204992718533960198873422331652203890694687581606454297990480548654013453468731594511042082506142247249703292802297282823810189281998227699520751780643097073526686726616784563956085175803076191642535125460576335323117943685062843987078714744017982793491520847338111803877691359603887361418277469031977197160563490963423432592864634816032855113853410792254728170568041125080899098994363809005476771923257523524645575257277084164876627623805977560647)
enc = (43567255585892811651572667414201899096506233207932168795489800875931299388052435129136214999183088033475919136437076586845373635116578938743790137634821625399498914646024136325621348588595144921376912166755858840152790869923022397159470182906965294067284620725584795780894259934546375144829275603674102787017900237527722363442918971957426165611712108955514118610292685319225319855254828341929754057112190211564137653706864250928310132822614910099121390318842513629765268224140333994906830985073372177286945051970654316412874083340223402025850637414393024483338878511344027266947675004933354716229084494749347457750018132855656468001283079067824495388131532482017977882869159898964655151495495572554595711692086485005956945668119511629380285621752823135420468432382521048633184346680564519184302690135809882920071921465845885628264432147078108515637373922878235697703337407180142008689926632408977964155294441215583289438498289940619027228070596043749176682104867002999321260963137599467756118599168642347066447982980064290968587460499884405783545815138708859219482507618237499851564458769172258531810316238203847525529391013924258680736038884465422188275567315580003580103235691553087259923365741178546228467234087944436213658920750983282025052006252240376153365318667278571267795228151622495207476839926328756830344014356864675800893908405258469753933176825030536012547228232454684857774430745960893331614744317906392901282826659977368003672479923760248893290763998294367509366653104043564424250495321940853016703519663069118468291933521820, 53165858617329748842523627986761126436275365677987345838395811080043912376434903519692641956852575988243702533888996743656796057524061231225362306152839010398105257614708241617822134656154595135117417132464371474387394059628784598703043628322249246255746518660453376210595923524100372932940242068664614122146343379984093772690595153496069487318829091090372088960180348488650000522293199600041161596534541766981134798227778983077746138670770271978483603604867323656141151475243897271717236401774189421777831100749757822733614474840650338390324139020351427851258299060134125438395216096977548277202924352484010958480798701795695358754485280773653720982539549950520262196514858670754513253338568506702410319321345908515618319249078375227327350822628609971460651138464286596884074805762495641452759831139783416379628024164468025082856470613856921186831031253763151374939491764756357856255527124829356961110861280381460310148151582388162971745428336761556036207280042677245829597580559185732108303075366304250125704115767115283201682227470611855406239784365333259376592404303232064105481337916862479800724024594994804153160298493477083436227271896760361873471756355905913642276665050753887766529083207134459511017675454363839417936044138427797407778428210204274612999483731687137666475413086985677850103990471591914638492449238777309412654945164679708940869707368369410069592725500286693207309674209336413742967830109209141758503013554511966314045270179669112158040920340920162337821525933678730266370748138355798206036941592616909729058130581208, 6922167925118743332491291486680498569174232704504471403804698582011916574895334607336236721118769524922157301320223011297674314922841965969727918987692125069508012772565595073321232653601855774198948154591553331331807839116830828849963202037771208498287307643052173586435610335284518494184110398932862809272314261174586032224510900338899375393210454562006279082975367225244661864311542919031785912921061477334753123207343706417058600318905948240354042467947189396165628442861130506351798617641482118230216749454070123371522352402931975601150903587618963761777903911796212100711303887555972612733940591221972993153698563468939039936571235945941645375527765863881803438976372922720193519754821361378927202575101553988939682730155086891540852084894675610437906157692465267874458588336127932427283217604858133144338805821690171112335567338032067698121358474657070870980906422304276031298799435222858118575908444465554730403423555669135986233163696664394650866667416033597343122790015422291219327289500351733401882818432099186138138525096842868604538867306625351541869548727571169530450435936358342360327414272934855602961658014039046615469711910729898569721899512138522524834013122019494905646181427308965793697224793541103832806708078746160943553953297871498215988010705435634941525383077417640102806016792480321047692084712923173253246591143136705673948446601703557059104089837433892605384807727473637824828685188009977524680171174018197798652044230230002748308602185454396011039205829153751929695983876432379683299002401775612174232435343230)
'''